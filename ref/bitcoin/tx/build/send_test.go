package build_test

import (
	"fmt"
	"github.com/memocash/index/ref/bitcoin/memo"
	"github.com/memocash/index/ref/bitcoin/tx/build"
	"github.com/memocash/index/ref/bitcoin/tx/gen"
	"github.com/memocash/index/ref/bitcoin/tx/script"
	"github.com/memocash/index/ref/bitcoin/util/testing/test_tx"
	"github.com/memocash/index/ref/bitcoin/wallet"
	"log"
	"testing"
)

type SendTest struct {
	Request  build.SendRequest
	Error    error
	TxHashes []test_tx.TxHash
}

func TestSend(t *testing.T) {
	for j, sendTest := range sendTests {
		tx, err := build.Send(sendTest.Request)
		if testing.Verbose() {
			log.Printf("SendTest %d:\n", j)
		}
		test_tx.Checker{
			Name:     fmt.Sprintf("TestSend %d", j),
			Txs:      []*memo.Tx{tx},
			Error:    sendTest.Error,
			TxHashes: sendTest.TxHashes,
		}.Check(err, t)
	}
}

var sendTest0simple = SendTest{
	Request: build.SendRequest{
		Wallet:  test_tx.GetAddress1WalletSingle100k(),
		Address: test_tx.Address2,
		Message: test_tx.TestMessage,
		Amount:  1000,
	},
	TxHashes: []test_tx.TxHash{{
		TxHash: "bdfc2d862059262b565b69dfb79d2f4e490d91a8cdd0e7be91a4d460a99b46ec",
		TxRaw:  "0100000001290c9e545233529c68f1efac662cb3370df17d08cdbaa7e63e04284e670ffef4000000006b483045022100ab4a4cd1092f9299c79e84011b5084e6d7c57aeb74e0f9184290c63e97ec0845022022e286d2e280145d5ddc520d3e000076ae13cd417f8eb9ed13ef81c73eee4ade412103065e9c67d6ef37c1b08f88d74a4b2090aa8d69f2e6ab5c116f60f05a78f2ededffffffff030000000000000000266a026d24140d4cd6490ddf863bbdf5c34d8ef1aebfd45c21050c53656e64206d657373616765e8030000000000001976a9140d4cd6490ddf863bbdf5c34d8ef1aebfd45c210588aca7810100000000001976a914fc393e225549da044ed2c0011fd6c8a799806b6288ac00000000",
	}},
}

var sendTest1simpleNoMessage = SendTest{
	Request: build.SendRequest{
		Wallet:  test_tx.GetAddress1WalletSingle100k(),
		Address: test_tx.Address2,
		Amount:  1000,
	},
	TxHashes: []test_tx.TxHash{{
		TxHash: "3b1f33e857252ae2e1262cf30d6f822727da3902a54330de15650e3f8100e718",
		TxRaw:  "0100000001290c9e545233529c68f1efac662cb3370df17d08cdbaa7e63e04284e670ffef4000000006a4730440220485e0c8625c0b19a6f5fb0b14b68d5ed224902e34bedaed28641485dd35c58510220707951b25e97aef87753909b3d836b3019ef67faf66d051b6db46d5b181b984e412103065e9c67d6ef37c1b08f88d74a4b2090aa8d69f2e6ab5c116f60f05a78f2ededffffffff02e8030000000000001976a9140d4cd6490ddf863bbdf5c34d8ef1aebfd45c210588acd6810100000000001976a914fc393e225549da044ed2c0011fd6c8a799806b6288ac00000000",
	}},
}

var sendTest2p2sh = SendTest{
	Request: build.SendRequest{
		Wallet:  test_tx.GetAddress1WalletSingle100k(),
		Address: test_tx.AddressP2sh1,
		Message: test_tx.TestMessage,
		Amount:  1000,
	},
	TxHashes: []test_tx.TxHash{{
		TxHash: "73432cef1f9b442afbb8eca033d710fa494c5f73c5dd60b6dc2b523c5f907fa9",
		TxRaw:  "0100000001290c9e545233529c68f1efac662cb3370df17d08cdbaa7e63e04284e670ffef4000000006a47304402202b6e0b4be985cc371c9e22566d8b81c68c0b0cd6b35ef5a5e907b3aa48331eb102207888c5d1fb199659860bed4c01f75d0a6f7e3cd395c9a03eb41b56149e3bb5ca412103065e9c67d6ef37c1b08f88d74a4b2090aa8d69f2e6ab5c116f60f05a78f2ededffffffff030000000000000000266a026d2414dd763c90ae1a5677d925c680673bba0a5e2874050c53656e64206d657373616765e80300000000000017a914dd763c90ae1a5677d925c680673bba0a5e28740587a9810100000000001976a914fc393e225549da044ed2c0011fd6c8a799806b6288ac00000000",
	}},
}

var sendTest2p2shNoMessage = SendTest{
	Request: build.SendRequest{
		Wallet:  test_tx.GetAddress1WalletSingle100k(),
		Address: test_tx.AddressP2sh1,
		Amount:  1000,
	},
	TxHashes: []test_tx.TxHash{{
		TxHash: "a35108a5b6fcfdf644ffe275f54e6053af3de47ccfaaf5d43adafcb99cf8d63a",
		TxRaw:  "0100000001290c9e545233529c68f1efac662cb3370df17d08cdbaa7e63e04284e670ffef4000000006a47304402205f4beb08b0149ad0c95e1117e0c4fd6191e289a75515a2a5a2922c5f587607bf02204a1f5b6a9f83689c273794e4c3571e6d6045a4559d693eb0630e00d777e4863d412103065e9c67d6ef37c1b08f88d74a4b2090aa8d69f2e6ab5c116f60f05a78f2ededffffffff02e80300000000000017a914dd763c90ae1a5677d925c680673bba0a5e28740587d8810100000000001976a914fc393e225549da044ed2c0011fd6c8a799806b6288ac00000000",
	}},
}

var sendTest4 = SendTest{
	Request: build.SendRequest{
		Wallet: build.Wallet{
			Getter:  gen.GetWrapper(&test_tx.TestGetter{UTXOs: test_tx.GetUtxosTestSet1()}, test_tx.Address1pkHash),
			Address: test_tx.Address1,
			KeyRing: wallet.GetSingleKeyRing(test_tx.Address1key),
		},
		Address: test_tx.AddressP2sh1,
		Amount:  test_tx.UtxosTestSet1MaxSend,
	},
	TxHashes: []test_tx.TxHash{{
		TxHash: "650b73221f2f58755d41318dfa615d4b9e75f07a3bfb5002dac62ca2bf51406c",
		TxRaw:  "010000000643ec7a579f5561a42a7e9637ad4156672735a658be2752181801f723ba3316d2000000006b483045022100e7fa279d38514b6b8ed187454497dcf9cfad80d1945cbfbaaf9e3de6d7fc2d9e0220693e74a7b930bf92c0508962baec192719010b3876a4797611718c18df51cea4412103065e9c67d6ef37c1b08f88d74a4b2090aa8d69f2e6ab5c116f60f05a78f2ededffffffff43ec7a579f5561a42a7e9637ad4156672735a658be2752181801f723ba3316d2010000006b483045022100c4fccda5edc52b602828cc688ca8cdcfa19a9ae5a1be098e6a6bf6439b96a3410220175d56944418560b7b34f0b7e6ee9e2e41515331ec5c72944fb6d1938c137d28412103065e9c67d6ef37c1b08f88d74a4b2090aa8d69f2e6ab5c116f60f05a78f2ededffffffff43ec7a579f5561a42a7e9637ad4156672735a658be2752181801f723ba3316d2020000006b48304502210090ce497001ff46bbe51d6558cd1e35ea1b1516af117ac6c339cebdb144c3982e02207ff6d39409b4022c058616ec21b71a4710d4f6fb0cc006a53e1e078577bfad4b412103065e9c67d6ef37c1b08f88d74a4b2090aa8d69f2e6ab5c116f60f05a78f2ededffffffff43ec7a579f5561a42a7e9637ad4156672735a658be2752181801f723ba3316d2030000006a4730440220552b128e73bbfa02c6504889698f079c42be280afe06e794e2d4c9a6a13d481402201303efe0b1de5d2586181cc5c9d313efd6a6a84b0e58e1d7e2573f0d557fcaf9412103065e9c67d6ef37c1b08f88d74a4b2090aa8d69f2e6ab5c116f60f05a78f2ededffffffff43ec7a579f5561a42a7e9637ad4156672735a658be2752181801f723ba3316d2040000006b4830450221008f58182385196772cfb5cdbbbcc85bd2bf6cd96e5f10b51bddd65f1dbe299fc1022043ef7e8ef8330dcf50370381dd3c2efe934e79fe10705e9394e12a835b02fb8a412103065e9c67d6ef37c1b08f88d74a4b2090aa8d69f2e6ab5c116f60f05a78f2ededffffffff43ec7a579f5561a42a7e9637ad4156672735a658be2752181801f723ba3316d2050000006b48304502210092173b91a4add2b7ed9c4feba8c46ab513bc507aa0c82330f57ebd3abe6769aa02205d3441b07ddc2189f8a9f1f5f626c8a8b8d36a2406e38f90b3cd182cd736f9dd412103065e9c67d6ef37c1b08f88d74a4b2090aa8d69f2e6ab5c116f60f05a78f2ededffffffff0126ef01000000000017a914dd763c90ae1a5677d925c680673bba0a5e2874058700000000",
	}},
}

var sendTest5 = SendTest{
	Request: build.SendRequest{
		Wallet: build.Wallet{
			Getter:  gen.GetWrapper(&test_tx.TestGetter{UTXOs: test_tx.GetUtxosTestSet1()}, test_tx.Address1pkHash),
			Address: test_tx.Address1,
			KeyRing: wallet.GetSingleKeyRing(test_tx.Address1key),
		},
		Message: test_tx.TestMessage,
		Address: test_tx.AddressP2sh1,
		Amount:  test_tx.UtxosTestSet1MaxSend - memo.OutputFeeOpReturn - memo.PkHashLength - memo.OutputOpDataFee - script.Len64([]byte(test_tx.TestMessage)),
	},
	TxHashes: []test_tx.TxHash{{
		TxHash: "430044fe192da8853630a7f804e78cf00f862e0c65f9be3b9fc5599a55427739",
		TxRaw:  "010000000643ec7a579f5561a42a7e9637ad4156672735a658be2752181801f723ba3316d2000000006a473044022002eb2bcaa7c48768a3cf64227cd94588e4cdad38a93f0969cae3098f3e592ad80220278d2dc02eecc487821ed6690c6c5e4bb25f1f3539dab7231dc3465f4e139509412103065e9c67d6ef37c1b08f88d74a4b2090aa8d69f2e6ab5c116f60f05a78f2ededffffffff43ec7a579f5561a42a7e9637ad4156672735a658be2752181801f723ba3316d2010000006b483045022100e3f40533192de68853c2b6f2557b0eb04b2963abc0010043e8aa8fe7d0a3d5b70220589f3a7a13770ede4c184ac56d2615420dd30ca537421c3799bf5ade39af7491412103065e9c67d6ef37c1b08f88d74a4b2090aa8d69f2e6ab5c116f60f05a78f2ededffffffff43ec7a579f5561a42a7e9637ad4156672735a658be2752181801f723ba3316d2020000006b4830450221009a892dcdfd6b9dd22eab5466f67e8b578e6bc80fb6e1b49a50bbf66e48c57e3602206b9b172bdfb977783235601d140627d16ed36559a69705ac58fa17d125871c8f412103065e9c67d6ef37c1b08f88d74a4b2090aa8d69f2e6ab5c116f60f05a78f2ededffffffff43ec7a579f5561a42a7e9637ad4156672735a658be2752181801f723ba3316d2030000006a47304402206470728b45fa9f800e575295f6243a47958624d2d20934405bc89a07f5d3dcb202200454b68f673aaab5c200bda2e96a1f2c5a6a5f86ad349d849689bf60b3b43a9c412103065e9c67d6ef37c1b08f88d74a4b2090aa8d69f2e6ab5c116f60f05a78f2ededffffffff43ec7a579f5561a42a7e9637ad4156672735a658be2752181801f723ba3316d2040000006b483045022100c333c6c06b2a5db83d0a79a46fd9c9fb87ee7595501e6f6b698d500d1c064573022029965744ab40bfd918dd43146f640547ae40941ef90edc99a1535937995a7af5412103065e9c67d6ef37c1b08f88d74a4b2090aa8d69f2e6ab5c116f60f05a78f2ededffffffff43ec7a579f5561a42a7e9637ad4156672735a658be2752181801f723ba3316d2050000006b483045022100e449823d9bb21ee2bd5982499fd48bfa2e7128fe4c8ef77434c1d0d6c9501cb9022013a957ee0db7c938e530f9169ce1f6bd386df250d85cce8cc621b5b192292572412103065e9c67d6ef37c1b08f88d74a4b2090aa8d69f2e6ab5c116f60f05a78f2ededffffffff020000000000000000266a026d2414dd763c90ae1a5677d925c680673bba0a5e2874050c53656e64206d657373616765efee01000000000017a914dd763c90ae1a5677d925c680673bba0a5e2874058700000000",
	}},
}

var sendTests = []SendTest{
	sendTest0simple,
	sendTest1simpleNoMessage,
	sendTest2p2sh,
	sendTest2p2shNoMessage,
	sendTest4,
	sendTest5,
}
